# 神煞系统设计方案 (ShenSha System Design)

由于 `lunar-javascript` SDK 并不直接提供针对八字四柱的神煞判定函数，本项目需要独立实现一套基于规则的神煞判定引擎。

## 1. 设计目标

神煞（Shen Sha）是八字命理中用于辅助判断吉凶的特殊标志。本项目 Phase 2 优先集成以下高频神煞：

- **地支相关（从日支或年支查）**：桃花、驿马、将星、华盖、劫煞、亡神。
- **月支相关（从月支查）**：天德贵人、月德贵人、天医。
- **日干相关（从日干查）**：天乙贵人、文昌贵人、羊刃、禄神。

## 2. 核心架构

在 `src/` 目录下新增 `shensha.ts` 模块，采用纯函数设计，不依赖外部状态。

### 2.1 模块结构

```typescript
// src/shensha.ts

/**
 * 神煞计算引擎
 */
export class ShenShaEngine {
  /**
   * 计算指定柱的神煞
   * @param pillars 四柱干支数据
   * @param targetPillar 要查哪一柱的神煞 (year | month | day | hour)
   */
  static getShenSha(pillars: Pillars, targetPillar: 'year' | 'month' | 'day' | 'hour'): string[] {
    // 逻辑：遍历所有规则，匹配即加入返回数组
  }
}
```

## 3. 神煞判定规则表

### 3.1 基于地支的三合/局判断
以下神煞通常由**年支**或**日支**触发，查找其他地支中是否存在对应字符。

| 神煞 | 查找基准 (年/日支) | 对应字符 (在其他柱出现) | 描述 |
| :--- | :--- | :--- | :--- |
| **桃花 (咸池)** | 寅午戌 | 卯 | 异性缘、艺术气质 |
| | 申子辰 | 酉 | |
| | 亥卯未 | 子 | |
| | 巳酉丑 | 午 | |
| **驿马** | 寅午戌 | 申 | 奔波、变动、远行 |
| | 申子辰 | 寅 | |
| | 亥卯未 | 巳 | |
| | 巳酉丑 | 亥 | |
| **华盖** | 寅午戌 | 戌 | 孤独、艺术、宗教、才华 |
| | 申子辰 | 辰 | |
| | 亥卯未 | 未 | |
| | 巳酉丑 | 丑 | |

### 3.2 基于月支的季节性判断
以**出生月份（月支）**为基准，查找各柱的天干或地支。

| 神煞 | 月支 (基准) | 对应天干/地支 (查各柱) | 描述 |
| :--- | :--- | :--- | :--- |
| **天医** | 子(11月) | 亥 (前一位地支) | 身体健康、适宜学医 |
| | 丑(12月) | 子 | |
| | ... | (月支前一位) | |
| **月德贵人** | 寅午戌月 | 丙 | 逢凶化吉之吉神 |
| | 申子辰月 | 壬 | |
| | 亥卯未月 | 甲 | |
| | 巳酉丑月 | 庚 | |

### 3.3 基于日干的禄命判断
以**日干**为基准。

| 神煞 | 日干 (基准) | 对应地支 | 描述 |
| :--- | :--- | :--- | :--- |
| **天乙贵人** | 甲/戊 | 丑、未 | 核心吉神，多得人助 |
| | 乙/己 | 子、申 | |
| | 丙/丁 | 亥、酉 | |
| | 庚/辛 | 寅、午 | |
| | 壬/癸 | 卯、巳 | |
| **禄神** | 甲 | 寅 | 官禄、财源之意 |
| | 乙 | 卯 | |
| | 丙/戊 | 巳 | |
| | 丁/己 | 午 | |
| | 庚 | 申 | |
| | 辛 | 酉 | |
| | 壬 | 亥 | |
| | 癸 | 子 | |

## 4. 集成方案

1. **逻辑整合**：在 `src/paipan.ts` 的 `calculateBazi` 函数中，在生成 `PillarData` 之后，调用 `ShenShaEngine` 对每一柱进行遍历。
2. **循环避免**：由于某些神煞需要四柱全量信息（如桃花要看年支或日支查其他柱），应在干支生成后统一计算。
3. **输出适配**：`formatter.ts` 已支持神煞显示，只需确保 `shensha` 数组不再为空即可。

## 5. 待办事项 (Next Steps)

- [ ] 实现 `src/shensha.ts`。
- [ ] 编写单元测试验证规则准确性（参考《三命通会》或《渊海子平》标准规则）。
- [ ] 修正 `lunar-javascript.d.ts`，移除不存在的 `getYearShenSha` 等声明，改为使用自定义引擎。
