这是一个基于 `lunar-javascript` SDK 开发的八字命理分析工具（CLI Skill）。通过引入成熟的库，我们极大简化了历法转换和基础排盘的复杂性，将重心放在了**真太阳时修正**、**数据结构化展示**及后续的**智能命理分析**上。

## 1. 整体架构设计

### 核心模块
- **输入解析 (Input Parser)**：处理 ISO 日期、城市名称或经度。
- **真太阳时修正 (TST Engine)**：根据出生地的经度及当日时差方程（EOT）计算当地精确时间。
- **排盘核心 (Core Paipan)**：基于 `lunar-javascript` 的基础数据生成四柱八字。
- **数据统计 (Aggregator)**：统计五行强弱、计算十神、纳音及神煞（规划中）。
- **格式化输出 (UI Formatter)**：提供结构化的终端展示，增强可视化体验。

---

## 2. 关键流程设计

### 流程图 (Data Flow)
1. **获取参数**：用户输入 `YYYY-MM-DD HH:mm` + `城市/经度`。
2. **时间修正**：
   - 查找城市经度（内置 `cities.ts` 库）。
   - 计算 **平太阳时 -> 真太阳时** 的偏移。
3. **SDK 排盘**：
   - 将修正后的时间通过 `Solar.fromYmdHms()` 转换为 `Lunar` 对象。
   - 调用 `lunar.getEightChar()` 获取天干地支。
4. **属性注入**：
   - 提取各柱十神、纳音、五行属性。
5. **渲染展示**：格式化为四柱方阵输出。

---

## 3. 功能模块详解

#### **A. 历法与排盘控制 (Leveraged by SDK)**
利用 `lunar-javascript` 自带能力处理以下命理细节：
- **节气判定**：精确处理立春、冬至等节点对年柱/月柱的影响。
- **早晚子时**：SDK 自动处理 23 点后的子时归属。
- **闰月处理**：自动进行农历与公历的逻辑转换。
- **十神/纳音**：基于日干的基础逻辑自动映射，无需手动编写复杂的六十甲子表。

#### **B. 真太阳时修正模块 (Custom Implementation)**
这是本项目相比于通用万年历的核心优势：
- **经度偏移**：1度 = 4分钟偏移（以 120°E 为基准）。
- **时差方程 (Equation of Time)**：考虑地球轨道离心率及黄道倾角导致的真平太阳时差。
- **逻辑**：排盘前先对输入时间执行 `adjustedTime = originalTime + (Longitude - 120) * 4 + EOT`。

#### **C. 命理分析模块 (Analyzer - 演进中)**
未来阶段的开发重心：
- **日主强弱**：结合月令、得地、得助等逻辑判断身强/身弱。
- **用神选取**：依据格局判定喜用神。
- **格局判定**：自动化扫描正官、七杀、食神等格局。

---

## 4. 技术栈

| 维度 | 技术选型 | 理由 |
| :--- | :--- | :--- |
| **开发语言** | TypeScript | 提供严格的命理数据类型定义，减少计算误差 |
| **历法库** | `lunar-javascript` | 成熟、专业，涵盖了藏干、五行、十神等核心计算 |
| **运行时** | Node.js | 兼容性广，适合作为命令行 Skill 运行 |
| **数据源** | 内置中国城市地理库 | 离线支持 3000+ 县级市经纬度查询 |

---

## 5. 挑战与优化点

1. **城市数据量**：内置数据虽全面，但需确保模糊搜索城市的性能。
2. **分析逻辑抽象**：命理流派（子平、新派、盲派等）逻辑差异大，分析模块需设计得足够插件化。
3. **响应式 UI**：在 CLI 中清晰展示大运排盘和流年走势。

---

## 6. 后续规划 (Roadmap)

- [x] 基于 SDK 的基础排盘
- [x] 高精度真太阳时修正
- [ ] 增加大运、流年排盘展示
- [ ] 实现核心神煞（桃花、驿马等）计算
- [ ] 自动化格局与喜忌分析模块
- [ ] 优化命令行交互体验与视觉效果
